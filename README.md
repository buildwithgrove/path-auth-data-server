<div align="center">
<h1>PADS<br/>PATH Auth Data Server</h1>
<img src="https://storage.googleapis.com/grove-brand-assets/Presskit/Logo%20Joined-2.png" alt="Grove logo" width="500"/>

</div>
<br/>

# Table of Contents <!-- omit in toc -->
- [1. Introduction](#1-introduction)
- [Gateway Endpoints](#gateway-endpoints)
- [2. Data Sources](#2-data-sources)
  - [2.1. YAML](#21-yaml)
  - [2.2. Postgres](#22-postgres)
- [3. gRPC Proto File](#3-grpc-proto-file)

## 1. Introduction

**PADS** (PATH Auth Data Server) is a gRPC server that provides authentication and authorization services for PATH's `Go External Authorization Server`.

## Gateway Endpoints

The PATH repo contains the `auth_Server` packages which contains the `Go External Authorization Server`.

This package defines the `GatewayEndpoints` proto file, which contains the definitions for the Gateway Endpoints that PADS must provides to the `Go External Authoriza tion Server`.

```go
// Simplified representation of the GatewayEndpoint proto message that 
// PADS must provide to the `Go External Authorization Server`.
type GatewayEndpoint struct {
    EndpointId: string
    Auth: {
        RequireAuth: bool
        AuthorizedUsers: map[string]struct{}
    }
    UserAccount: {
        AccountId: string
        PlanType: string
    }
    RateLimiting: {
        ThroughputLimit: int32
        CapacityLimit: int32
        CapacityLimitPeriod: CapacityLimitPeriod [enum]
    }
}
```

## 2. Data Sources

The `server` package contains the `DataSource` interface, which abstracts the data source that provides GatewayEndpoints to the `Go External Authorization Server`.

```go
// DataSource is an interface that abstracts the data source.
// It can be implemented by any data provider (e.g., YAML, Postgres).
type DataSource interface {
	GetInitialData() (*proto.InitialDataResponse, error)
	SubscribeUpdates() (<-chan *proto.Update, error)
}
```

- `GetInitialData()` returns the initial data for the Gateway Endpoints.
  - This is called when the `Go External Authorization Server` starts to populate its Gateway Endpoint Data Store.
- `SubscribeUpdates()` returns a channel that receives updates to the Gateway Endpoints.
  - Updates are streamed as changes are made to the data source.

### 2.1. YAML

If the `YAML_FILEPATH` environment variable is set, PADS will load the data from a YAML file at the specified path.

Hot reloading is supported, so changes to the YAML file will be reflected in the `Go External Authorization Server` without the need to restart PADS.

The YAML file must be formatted as follows:

```yaml
endpoints:
  endpoint_1:
    endpoint_id: "endpoint_1"
    auth:
      require_auth: true
      authorized_users:
        "auth0|user_1": {}
    user_account:
      account_id: "account_1"
      plan_type: "PLAN_UNLIMITED"

  endpoint_2:
    endpoint_id: "endpoint_2"
    auth:
      require_auth: false
    user_account:
      account_id: "account_2"
      plan_type: "PLAN_FREE"
    rate_limiting:
      throughput_limit: 30
      capacity_limit: 100000
      capacity_limit_period: "CAPACITY_LIMIT_PERIOD_MONTHLY"
```

### 2.2. Postgres

If the `POSTGRES_CONNECTION_STRING` environment variable is set, PADS will connect to the specified Postgres database.

**TODO - add further details on Postgres implementation**

## 3. gRPC Proto File

The PATH `auth_server` package contains the file `gateway_endpoint.proto`, which contains:
- The gRPC auto-generated Go struct definitions for the GatewayEndpoints.
- The `GetInitialData` and `StreamUpdates` methods that the `Go External Authorization Server` uses to populate and update its Gateway Endpoint Data Store.

The autogenerated Go code from the `gateway_endpoint.proto` file is installed in PADS from the `github.com/buildwithgrove/path/envoy/auth_server` package.